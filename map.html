<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Guerrilla Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">Loading map…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map = null;
    let userMarker = null;

    const FALLBACK = { lat: -29.858, lng: 31.021 };

    const markerIcon = L.icon({
      iconUrl:    'https://i.ibb.co/ghQpS4H/marker-icon.png',
      shadowUrl:  'https://i.ibb.co/GvH6GsJX/marker-shadow.png',
      iconSize:     [25, 41],
      shadowSize:   [41, 41],
      iconAnchor:   [12, 41],
      shadowAnchor: [12, 41],
      popupAnchor:  [1, -34]
    });

    // ── Initialize map ────────────────────────────────────────
    function initMap() {
      map = L.map('map', {
        zoomControl: true,
        zoomAnimation: true,
        fadeAnimation: true
      }).setView([FALLBACK.lat, FALLBACK.lng], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
      }).addTo(map);

      userMarker = L.marker([FALLBACK.lat, FALLBACK.lng], { icon: markerIcon })
        .addTo(map)
        .bindPopup('Waiting for location…')
        .openPopup();

      // Force multiple resize calls — this fixes cut-off map in WebViewer
      setTimeout(() => { map.invalidateSize(); console.log("Resize 1"); }, 300);
      setTimeout(() => { map.invalidateSize(); console.log("Resize 2"); }, 800);
      setTimeout(() => { map.invalidateSize(); console.log("Resize 3"); }, 1500);
      setTimeout(() => { map.invalidateSize(); console.log("Resize 4"); }, 3000);
    }

    // ── Kodular injection functions ───────────────────────────
    window.setInitialPosition = function(lat, lng) {
      console.log("setInitialPosition →", lat, lng);
      updatePosition(lat, lng, "Your position – tap to plant!");
    };

    window.updateUserPosition = function(lat, lng) {
      console.log("updateUserPosition →", lat, lng);
      updatePosition(lat, lng, "Your position – tap to plant!<br><small>Live</small>");
    };

    function updatePosition(lat, lng, popupText) {
      if (!map || !userMarker) {
        console.warn("Map/marker not ready yet");
        return;
      }

      const newLat = Number(lat);
      const newLng = Number(lng);

      if (isNaN(newLat) || isNaN(newLng)) return;

      userMarker.setLatLng([newLat, newLng]);
      userMarker.setPopupContent(popupText);
      userMarker.openPopup();

      map.flyTo([newLat, newLng], 15, { duration: 1.0 });

      // Hide loading
      const loading = document.getElementById('loading');
      if (loading) {
        loading.classList.add('hidden');
        setTimeout(() => loading.style.display = 'none', 600);
        console.log("Loading hidden");
      }
    }

    // Start map
    initMap();

    // Safety net — hide loading even if nothing else works
    setTimeout(() => {
      const loading = document.getElementById('loading');
      if (loading && loading.style.display !== 'none') {
        loading.style.display = 'none';
        console.log("Safety net: loading hidden after timeout");
      }
    }, 6000);
  </script>
</body>
</html>

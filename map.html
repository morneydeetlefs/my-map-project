<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5ir/XP5y4=" crossorigin="anonymous" />

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      z-index: 9999;
      transition: opacity 0.4s;
    }
    #loading.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">Loading map…</div>

  <!-- Load Leaflet from CDN with integrity check -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <script>
    // ─────────────────────────────────────────────
    // 1. Global variables
    // ─────────────────────────────────────────────
    let map = null;
    let userMarker = null;

    const FALLBACK = { lat: -29.858, lng: 31.021 };
    let currentPosition = { ...FALLBACK };

    // ─────────────────────────────────────────────
    // 2. Create custom icon (replace URLs with yours)
    // ─────────────────────────────────────────────
    const markerIcon = L.icon({
      iconUrl:    'https://i.ibb.co/ghQpS4H/marker-icon.png',
      shadowUrl:  'https://i.ibb.co/GvH6GsJX/marker-shadow.png',
      iconSize:     [25, 41],
      shadowSize:   [41, 41],
      iconAnchor:   [12, 41],
      shadowAnchor: [12, 41],
      popupAnchor:  [1, -34]
    });

    // ─────────────────────────────────────────────
    // 3. Initialize map
    // ─────────────────────────────────────────────
    function initMap() {
      try {
        map = L.map('map', {
          zoomControl: true,
          zoomAnimation: true,
          fadeAnimation: true
        }).setView([FALLBACK.lat, FALLBACK.lng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          maxZoom: 19
        }).addTo(map);

        // Create marker
        userMarker = L.marker([FALLBACK.lat, FALLBACK.lng], { icon: markerIcon })
          .addTo(map)
          .bindPopup('Waiting for location…')
          .openPopup();

        // Force redraw (very important in WebView)
        setTimeout(() => map.invalidateSize(), 300);

        console.log("Map initialized successfully");
      } catch (e) {
        console.error("Map init failed", e);
        document.getElementById('loading').textContent = "Map failed to load";
      }
    }

    // ─────────────────────────────────────────────
    // 4. Functions Kodular can call
    // ─────────────────────────────────────────────

    window.setInitialPosition = function(lat, lng) {
      console.log("setInitialPosition →", lat, lng);
      updatePosition(lat, lng, "Position loaded from storage");
    };

    window.updateUserPosition = function(lat, lng) {
      console.log("updateUserPosition →", lat, lng);
      updatePosition(lat, lng, "Your position – tap to plant!");
    };

    function updatePosition(lat, lng, popupText) {
      if (!map || !userMarker) {
        console.warn("Map or marker not ready yet");
        return;
      }

      const newLat = Number(lat);
      const newLng = Number(lng);

      if (isNaN(newLat) || isNaN(newLng)) {
        console.warn("Invalid coordinates received");
        return;
      }

      // Update marker
      userMarker.setLatLng([newLat, newLng]);
      userMarker.setPopupContent(popupText);
      userMarker.openPopup();

      // Move map view
      map.flyTo([newLat, newLng], 15, {
        duration: 1.1,
        easeLinearity: 0.25
      });

      // Hide loading
      const loading = document.getElementById('loading');
      loading.classList.add('hidden');
      setTimeout(() => loading.style.display = 'none', 500);

      console.log("Position updated & loading hidden");
    }

    // Start map initialization
    initMap();
  </script>
</body>
</html>

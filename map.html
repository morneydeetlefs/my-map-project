<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Guerrilla Gardens â€“ Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, Helvetica, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #welcome {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 16px;
      border-radius: 12px;
      z-index: 9000;
      font-size: 1.1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    #welcome button {
      margin-top: 12px;
      padding: 10px 24px;
      font-size: 1.1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">Loading mapâ€¦</div>

  <div id="welcome" style="display:none;">
    <p>Welcome to Guerrilla Gardens!</p>
    <p>Tap anywhere to place your first garden (one-time free move).</p>
    <p>After that, your saved location will load here automatically.</p>
    <button onclick="document.getElementById('welcome').style.display='none'">Got it!</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  let map = null;
  let userMarker = null;
  let firstPlacementConfirmed = false;

  const FALLBACK = { lat: -29.858, lng: 31.021 };
  const markerIcon = L.icon({
    iconUrl: 'https://i.ibb.co/ghQpS4H/marker-icon.png',
    shadowUrl: 'https://i.ibb.co/GvH6GsJX/marker-shadow.png',
    iconSize: [25, 41],
    shadowSize: [41, 41],
    iconAnchor: [12, 41],
    shadowAnchor: [12, 41],
    popupAnchor: [1, -34]
  });

  // â”€â”€ Initialize map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initMap() {
    map = L.map('map', {
      zoomControl: true,
      zoomAnimation: true,
      fadeAnimation: true
    }).setView([FALLBACK.lat, FALLBACK.lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(map);

    userMarker = L.marker([FALLBACK.lat, FALLBACK.lng], { icon: markerIcon })
      .addTo(map)
      .bindPopup('Waiting for locationâ€¦')
      .openPopup();

    // â”€â”€ IMPORTANT: Attach the click listener HERE, after map is created â”€â”€
    map.on('click', function(e) {
      if (firstPlacementConfirmed) return;

      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      userMarker.setLatLng([lat, lng]);

      userMarker.setPopupContent(
        'Place your first garden here?<br>' +
        '<button onclick="confirmFirstPlacement()">Yes â€“ Confirm</button>'
      ).openPopup();
    });

    // Multiple resize calls
    setTimeout(() => { map.invalidateSize(); console.log("Resize 1"); }, 300);
    setTimeout(() => { map.invalidateSize(); console.log("Resize 2"); }, 800);
    setTimeout(() => { map.invalidateSize(); console.log("Resize 3"); }, 1500);
    setTimeout(() => { map.invalidateSize(); console.log("Resize 4"); }, 3000);
  }

  // â”€â”€ Confirm function (must be global for popup button) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function confirmFirstPlacement() {
    if (firstPlacementConfirmed) return;

    const pos = userMarker.getLatLng();
    const lat = pos.lat;
    const lng = pos.lng;

    console.log("First placement confirmed:", lat, lng);

    userMarker.setPopupContent('First garden saved! ðŸŒ±').openPopup();

    if (window.Android && window.Android.saveFirstGardenPosition) {
      window.Android.saveFirstGardenPosition(lat, lng);
    }

    firstPlacementConfirmed = true;
  }

  // â”€â”€ Functions called from Kodular â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.setLocationAndZone = function(lat, lng, zoneName, zoneDescription) {
    console.log("Received from app:", lat, lng, zoneName, zoneDescription);

    const newLat = Number(lat);
    const newLng = Number(lng);

    if (isNaN(newLat) || isNaN(newLng)) {
      console.warn("Invalid coordinates â€“ using fallback");
      newLat = FALLBACK.lat;
      newLng = FALLBACK.lng;
    }

    // Move marker
    if (userMarker) {
      userMarker.setLatLng([newLat, newLng]);
    } else {
      userMarker = L.marker([newLat, newLng], { icon: markerIcon }).addTo(map);
    }

    // Popup with zone info
    let popupContent = `Your garden location<br><strong>${zoneName || 'Unknown Zone'}</strong>`;
    if (zoneDescription) {
      popupContent += `<br><small>${zoneDescription}</small>`;
    }
    userMarker.setPopupContent(popupContent).openPopup();

    // Center map
    map.flyTo([newLat, newLng], 15, { duration: 1.2 });

    // Hide loading
    const loading = document.getElementById('loading');
    if (loading) {
      loading.classList.add('hidden');
      setTimeout(() => loading.style.display = 'none', 600);
    }
  };

  // Start map initialization
  initMap();

  // Ultimate safety net
  setTimeout(() => {
    const loading = document.getElementById('loading');
    if (loading) {
      loading.style.display = 'none';
      console.log("Safety net: loading hidden");
    }
  }, 8000);
</script>
</body>
</html>

